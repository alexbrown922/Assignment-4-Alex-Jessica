---
title: "Assignment_4_Jessica_Alex"
author: "Alex Brown Jessica Jagdeo"
date: "11/14/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}

# A. Load packages and read in data files.


library(tidyverse)
library(knitr)
library(kableExtra)
library(plotly)
library(pwr)
library(car)
library(RColorBrewer)
library(extrafont)
library(ggrepel)
library(effsize)
library(ggpubr)
library(vcdExtra)
library(dplyr)
library(RColorBrewer)

lobster_abundance <- read_csv("lobster_size_abundance.csv")

lobster_traps <- read_csv("lobster_traps.csv")

```

###1
```{r}

# B. Display data frame lobster_abundance in tidy format

# First, simplify lobster_abundance data frame by removing rows with COUNT = 0

lobster_abundance_simp <- lobster_abundance %>% 
  filter(COUNT != 0) %>%  
  group_by(SITE, YEAR)

# Second, create tidy formatted data frame using expand.dft

lobster_abundance_tidy <- expand.dft(as.data.frame(lobster_abundance_simp), var.names = NULL, freq = "COUNT")

# Use lobster_abundance_tidy for all calculations (except column graph)


# Filter lobster_traps to include only the 5 pertinent sites

lobster_traps_simp <- lobster_traps %>% 
  filter(SITE == "AQUE" | SITE == "CARP" | SITE == "IVEE" | SITE == "MOHK" | SITE == "NAPL")

```

```{r, fig.height=5}

# C. Determine the best graphical way to depict abundance and traps data: column or line graphs? Create column graphs and line graphs of lobster abundance by year at each of the 5 sites

# First, create summary table of counts of lobsters at each site for each year

size_summary_graphs <- lobster_abundance_tidy %>% 
  group_by(SITE, YEAR) %>% 
  filter(YEAR == "2012" | YEAR == "2013" | YEAR == "2014" | YEAR == "2015" | YEAR == "2016" | YEAR == "2017") %>% 
  summarize(
    sample_size = length(SIZE)
  )

size_summary_graphs



labels <- c(AQUE = "Arroyo Quemado", CARP = "Carpinteria", IVEE = "Isla Vista", MOHK = "Mohawk Reef", NAPL = "Naples Reef")


abundance_col <- ggplot(size_summary_graphs, aes(x = YEAR, y = sample_size))+
  geom_col(aes(fill = SITE)) +
  scale_fill_manual(values = c("seagreen3", "violetred1", "sienna1", "slateblue1", "paleturquoise3")) +
  scale_y_continuous(expand = c(0,0)) +
  theme_classic() +
  xlab("\nYear") +
  ylab("Lobster Count\n") +
  facet_wrap(~SITE, scales = "free", labeller = labeller(SITE = labels)) +
  facet_grid(cols = vars(SITE), scales = "free_y", labeller = labeller(SITE = labels)) +
  theme(legend.position = "none") +
  theme(panel.spacing = unit(1, "lines")) 

abundance_col


abundance_line <- ggplot(size_summary_graphs, aes(x = YEAR, y = sample_size, group = SITE)) +
  geom_line(aes(color = SITE)) +
  geom_point() + 
  theme_classic() +
  xlab("\nYear") +
  ylab("Count\n") 

abundance_line

# Note for Jess: Need to add space between facet_wrap labels and plots
# Note for Jess: free scales in facet_grid

# I prefer the column graph - easier to visualize changes per location
    
    
```
**Figure 1. California Spiny Lobster Abundance at Five Long-Term Ecological Research Sites in the Santa Barbara Channel, 2012-2017.** Divers collected lobster abundance data for Panulirus interruptus at each of the five sites each year in late summer, before the start of the fishing season. The sites are Arroyo Quemado (AQUE), Naples Reef (NAPL), Mohawk Reef (MOHK), Isla Vista (IVEE), and Carpinteria (CARP). NAPL and IVEE are marine protected areas; AQUE, MOHK, and CARP are non-marine protected areas. Data source: Reed, D., Santa Barbara Coastal Long Term Ecological Research Project. 


```{r, fig.height=4}

# D. Create column graphs of fishing pressure (trap buoys) by year at each of the 5 sites

traps_col <- lobster_traps_simp %>% 
  filter(SITE != "IVEE",
         SITE != "NAPL") %>% 
  ggplot(aes(x = YEAR, y = TRAPS))+
  geom_col(aes(fill = SITE)) +
  scale_fill_manual(values = c("seagreen3", "violetred1", "slateblue1")) +
  scale_y_continuous(expand = c(0,0)) +
  theme_classic() +
  xlab("\nYear") +
  ylab("Number of Traps\n") +
  facet_wrap(~SITE, labeller = labeller(SITE = labels)) +
  theme(legend.position = "none") +
  theme(panel.spacing = unit(1, "lines"))
  

traps_col


# Note for Jess: Need to add space between facet_wrap labels and plots

```
**Figure 2. Commercial Lobster Trap Floats at Long-Term Ecological Research Sites in the Santa Barbara Channel, 2012-2017.** Data on the number of floats was collected every two to four weeks Oct-Mar, during the lobster fishing season. Commercial lobster trap floats act as indicators of fishing pressure at each location. NAPL and IVEE lack commercial trap floats because they are marine protected areas. Data source: Reed, D., Santa Barbara Coastal Long Term Ecological Research Project. 





###2


```{r}
# 2

# Compare mean lobster sizes (carapace length (mm)) across the five sites for lobster observations collected in 2017. Create a bar graph with standard deviation

# create a new df with mean lobster sizes at the 5 locations

mean_lobster_size <- lobster_abundance_tidy %>% 
  select(YEAR, SITE, SIZE) %>% 
  filter(YEAR == "2017") %>% 
  group_by(SITE) %>% 
  summarize(mean = round(mean(SIZE), 2))

mean_lobster_size

# create a table comparing mean lobster sizes at the 5 locations

mean_lobster_tbl <- mean_lobster_size %>% 
  kable(col.names = c("Site", "Mean Lobster Carapace Length (mm)"),
        caption = "Mean Lobster Sizes at 5 Locations in 2017") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", full_width = FALSE)) %>% 
  row_spec(row = 5, bold = TRUE, color = "green")
  

mean_lobster_tbl

# create a column graph of mean lobster sizes at the 5 locations 

mean_lobster_col <- ggplot(mean_lobster_size, aes(x = SITE, y = mean)) + 
  geom_col(aes(fill = SITE)) +
  scale_y_continuous(expand = c(0,0)) +
  theme_classic() +
  xlab("Site") +
  ylab("Mean Carapace Length (mm)") +
  theme(legend.position = "none") +
  theme(panel.spacing = unit(1, "lines"))

mean_lobster_col

# Run an ANOVA test

# Single factor: SITE (location)
# Number of levels: 5 (IVEE, AQUE, CARP, MOHK, NAPL)
# Random variable: SIZE (mm)

# Is there a significant difference in mean lobster size (mm) for sites IVEE, AQUE, CARP, MOHK, NAPL? 

# HO: mean lobster sizes across all sites are equal
# HA: At least two means differ significantly 

lobster_aov <- aov(SIZE ~ SITE, data = lobster_abundance_tidy)

summary(lobster_aov)

# post-hoc testing using Tukey's HSD

lobster_ph <- TukeyHSD(lobster_aov)

lobster_ph
```
Note: Put in-line referencing for F statistic and figure out how to interpret p-values for comparison of sites. Use standard error for the graph

Mean lobster sizes (carapace length (mm)) at Arroyo Quemado, Naples Reef, Mohawk Reef, Isla Vista, and Carpinteria locations are significantly differerent in some instances from each other and not significantly different in others. (F(4) = 21.65, p, $\alpha$ = .05 with post-hoc Tukey's HSD, $\alpha = 0.05$.

Sig-diff: 

NAPL-AQUE
MOHK-CARP
NAPL-CARP
MOHK-IVEE
NAPL-IVEE
NAPL-MOHK

Not sig-diff:

CARP-AQUE
IVEE-AQUE
MOHK-AQUE
IVEE-CARP



For number 3, conduct 5 two sample t-tests for each location between 2012 and 2017 and see the significant changes at each MPA and non-MPA location and compare in discussion.

```{r}

# 3. At Isla Vista and Naples Reef, the two protected MPA sites (with zero fishing pressure), how do lobster sizes in 2012 and 2017 compare? At the non-MPA sites?
# Run 5 two-sample t-tests for each location, with samples being 2012 and 2017

# First, look at data and see if its normal

size_hist_2012 <- lobster_abundance_tidy %>% 
  filter( YEAR == "2012") %>% 
  ggplot(aes(x = SIZE)) +
  geom_histogram() +
  facet_wrap(~ SITE) 

size_hist_2012

size_hist_2017 <- lobster_abundance_tidy %>% 
  filter(YEAR == "2017") %>% 
  ggplot(aes(x = SIZE)) +
  geom_histogram() +
  facet_wrap(~ SITE)

size_hist_2017


size_qq_2012 <-lobster_abundance_tidy %>% 
  filter( YEAR == "2012") %>% 
  ggplot(aes(sample = SIZE)) +
  geom_qq() +
  facet_wrap(~ SITE)

size_qq_2012

size_qq_2017 <-lobster_abundance_tidy %>% 
  filter( YEAR == "2017") %>% 
  ggplot(aes(sample = SIZE)) +
  geom_qq() +
  facet_wrap(~ SITE)

size_qq_2017

size_summary <- lobster_abundance_tidy %>% 
  group_by(SITE, YEAR) %>% 
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  summarize(
    sample_size = length(SIZE)
  )

size_summary

# Based on the histograms and qq-plots, the size data for the sites are approximately normal, except for Naples 2012, which only has 5 samples. We can use t-tests for these samples because the t-distribution allows for some uncertainty. 


```

```{r}

# 3. At Isla Vista and Naples Reef, the two protected MPA sites (with zero fishing pressure), how do lobster sizes in 2012 and 2017 compare? At the non-MPA sites?
# Run 5 two-sample t-tests for each location, with samples being 2012 and 2017

# Second, do F-tests for equal variance for each site to determine if we will use a Welch's t-test or Student's t-test 

# F-test for equal variances
# Null: The variances are equal (ratio of variances = 1)
# Alternative: The variances aren't equal (ratio of variances NOT = 1)

f_test_arroyo <- lobster_abundance_tidy %>% 
  filter(YEAR == "2012" | YEAR == "2017", SITE == "AQUE") %>% 
  var.test(SIZE ~ YEAR, data = .)

f_test_arroyo

# Based on the F-test, for Arroyo, we fail to reject the null that the variances for the 2012 and 2017 samples are equal (p = 0.298). Use a student's t-test.

f_test_carp <- lobster_abundance_tidy %>% 
  filter(YEAR == "2012" | YEAR == "2017", SITE == "CARP") %>% 
  var.test(SIZE ~ YEAR, data = .)

f_test_carp

# Based on the F-test, for Carpinteria, we fail to reject the null that the variances for the 2012 and 2017 samples are equal (p = 0.204). Use student's t-test.

f_test_ivee <- lobster_abundance_tidy %>% 
  filter(YEAR == "2012" | YEAR == "2017", SITE == "IVEE") %>% 
  var.test(SIZE ~ YEAR, data = .)

f_test_ivee

# Based on the F-test, for Isla Vista, we fail to reject the null that the variances for the 2012 and 2017 samples are equal (p = 0.307). Use student's t-test.

f_test_mohk <- lobster_abundance_tidy %>% 
  filter(YEAR == "2012" | YEAR == "2017", SITE == "MOHK") %>% 
  var.test(SIZE ~ YEAR, data = .)

f_test_mohk

# Based on the F-test, for Mohawk Reef, we fail to reject the null that the variances for the 2012 and 2017 samples are equal (p = 0.151). Use student's t-test.

f_test_napl <- lobster_abundance_tidy %>% 
  filter(YEAR == "2012" | YEAR == "2017", SITE == "NAPL") %>% 
  var.test(SIZE ~ YEAR, data = .)

f_test_napl

# Based on the F-test, for Naples Reef, we fail to reject the null that the variances for the 2012 and 2017 samples are equal (p = 0.768). Use student's t-test.


```

```{r}

# 3. At Isla Vista and Naples Reef, the two protected MPA sites (with zero fishing pressure), how do lobster sizes in 2012 and 2017 compare? At the non-MPA sites?
# Run 5 two-sample t-tests for each location, with samples being 2012 and 2017

# Third, run 5 student's t-tests for 2012 and 2017 lobster sizes at each location:

# Null: There is no significant difference in sizes for 2012 and 2017 lobster samples
# Alternative: There is a significant difference in sizes for 2012 and 2017 lobster samples

# Fourth, run Cohen's D to determine effect sizes



arroyo_ttest <- lobster_abundance_tidy %>% 
  filter(YEAR == "2012" | YEAR == "2017", SITE == "AQUE") %>% 
  t.test(SIZE ~ YEAR, var.equal = TRUE, data = .)

arroyo_ttest

# Based on the student's t-test, there is no significant difference in mean sizes for lobster samples collected in 2012 and 2017 at Arroyo Quemado (p = 0.209, `r round(arroyo_ttest$p.value,3)).

arroyo_eff_size <- lobster_abundance_tidy %>% 
  filter(YEAR == "2012" | YEAR == "2017", SITE == "AQUE") %>% 
  cohen.d(SIZE ~ YEAR, data = .)

arroyo_eff_size

# Small Cohen's D (-0.256, `r round(arroyo_eff_size$estimate,2)`)



carp_ttest <- lobster_abundance_tidy %>% 
  filter(YEAR == "2012" | YEAR == "2017", SITE == "CARP") %>% 
  t.test(SIZE ~ YEAR, var.equal = TRUE, data = .)

carp_ttest

# Based on the student's t-test, there is no significant difference in mean sizes for lobster samples collected in 2012 and 2017 at Carpinteria (p = 0.182, `r round(carp_ttest$p.value,3)).

carp_eff_size <- lobster_abundance_tidy %>% 
  filter(YEAR == "2012" | YEAR == "2017", SITE == "CARP") %>% 
  cohen.d(SIZE ~ YEAR, data = .)

carp_eff_size

# Cohen's D is negligible. 



ivee_ttest <- lobster_abundance_tidy %>% 
  filter(YEAR == "2012" | YEAR == "2017", SITE == "IVEE") %>% 
  t.test(SIZE ~ YEAR, var.equal = TRUE, data = .)

ivee_ttest

# Based on the student's t-test, there is no significant difference in mean sizes for lobster samples collected in 2012 and 2017 at Isla Vista (p = 0.059, `r round(ivee_ttest$p.value,3)).

ivee_eff_size <- lobster_abundance_tidy %>% 
  filter(YEAR == "2012" | YEAR == "2017", SITE == "IVEE") %>% 
  cohen.d(SIZE ~ YEAR, data = .)

ivee_eff_size

# Small COhen's D (-0.377, `r round(ivee_eff_size$estimate,2)`)



mohk_ttest <- lobster_abundance_tidy %>% 
  filter(YEAR == "2012" | YEAR == "2017", SITE == "MOHK") %>% 
  t.test(SIZE ~ YEAR, var.equal = TRUE, data = .)

mohk_ttest

# Based on the student's t-test, there IS a significant difference in mean sizes for lobster samples collected in 2012 and 2017 at Mohawk Reef (p < 0.05).

mohk_eff_size <- lobster_abundance_tidy %>% 
  filter(YEAR == "2012" | YEAR == "2017", SITE == "MOHK") %>% 
  cohen.d(SIZE ~ YEAR, data = .)

mohk_eff_size

# Medium Cohen's D (0.54, `r round(mohk_eff_size$estimate,2)`)



napl_ttest <- lobster_abundance_tidy %>% 
  filter(YEAR == "2012" | YEAR == "2017", SITE == "NAPL") %>% 
  t.test(SIZE ~ YEAR, var.equal = TRUE, data = .)

napl_ttest


# Based on the student's t-test, there is no significant difference in mean sizes for lobster samples collected in 2012 and 2017 at Naples (p = 0.500, `r round(napl_ttest$p.value,3)).

napl_eff_size <- lobster_abundance_tidy %>% 
  filter(YEAR == "2012" | YEAR == "2017", SITE == "NAPL") %>% 
  cohen.d(SIZE ~ YEAR, data = .)

napl_eff_size

# Small effect size, Cohen's D = (-0.283, `r round(napl_eff_size$estimate,2)`)

# Difference in means = (`r diff(napl_ttest$estimate)`)

```
California spiny lobster sizes were measured by divers at marine protected areas (Isla Vista and Naples Reef) and non-marine protected areas (Arroyo Quemado, Carpinteria, and Mohawk Reef) in 2012 and 2017. Of the five locations, only lobsters at Mohawk Reef exhibited a significant change in mean size between 2012 (mean +/- sd) and 2017 (mean +/- sd), based on results from a two-sample Student's t-test [t(`r round(mohk_ttest$parameter,2)`) = `r round(mohk_ttest$statistic,2)`, *p* < 0.05, $\alpha$ = 0.05]. In addition, the effect size is moderate (Cohen's d = `r round(mohk_eff_size$estimate,2)`).


### 4

The legal minimum carapace size for lobster is 82.6 mm. What proportion of observed lobsters at each site are above the legal minimum? Does that proportion differ significantly across the 5 sites? (chi-sq) 2017
```{r}
# 4

# create a df of lobster sizes above and below 83 mm at each site; size = "legal" or "not leagal"

lobster_legal <- lobster_abundance_tidy %>% 
  mutate(size=ifelse(SIZE <= 83, "Not Legal", "Legal")) %>% 
  filter(YEAR == "2017")

lobster_legal

# create a table for legal and illegal lobster sizes 

lobster_legal_tbl <- lobster_legal %>%
  count(SITE, size) %>% 
  spread(size, n) %>% 
  select(-SITE)

rownames(lobster_legal_tbl) <- c("AQUE", "CARP", "IVEE", "MOHK", "NAPL")

lobster_legal_tbl

# maybe this is useful somehow? counts of lobster sizes at each site

lobster_counts <- lobster_abundance_tidy %>% 
  filter(YEAR == "2017") %>%
  mutate(SIZE >= "83", SIZE <= "82") %>%
  group_by(SITE) %>% 
  select(-MONTH, -DATE, -SBC_LTER_TRANSECT, -LOBSTER_TRANSECT) %>% 
  count(SITE, SIZE)
  
lobster_counts

# convert counts to proportions 

lobster_prop <- prop.table(as.matrix(lobster_legal_tbl))

lobster_prop

# run a chi-sq test

# We ask: "Is there a significant association between site and lobster carapace length (mm)?"

lobster_x2 <- chisq.test(lobster_prop)

lobster_x2
```

"Lobster carapace length (mm) differed insignificantly between AQUE (n = ), Carpinteria (n = ), Isla Vista (n = ), MOHK (n = ), and Naples (n = ) ($\chi^2$(`r lobster_x2$parameter`) =  ....., p = 1).
