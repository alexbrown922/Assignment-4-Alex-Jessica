---
title: "Assignment_4_Jessica_Alex"
author: "Alex Brown Jessica Jagdeo"
date: "11/14/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}

# A. Load packages and read in data files.
# Alex, install vcdExtra before loading this package


library(tidyverse)
library(knitr)
library(kableExtra)
library(plotly)
library(pwr)
library(car)
library(RColorBrewer)
library(extrafont)
library(ggrepel)
library(effsize)
library(ggpubr)
library(vcdExtra)
library(dplyr)

lobster_abundance <- read_csv("lobster_size_abundance.csv")

lobster_traps <- read_csv("lobster_traps.csv")

```

###1
```{r}

# B. Display data frame lobster_abundance in tidy format

# First, simplify lobster_abundance data frame by removing rows with COUNT = 0

lobster_abundance_simp <- lobster_abundance %>% 
  filter(COUNT != 0) %>% 
  as.data.frame(lobster_abundance_simp) %>% 
  group_by(SITE, YEAR)

# Second, create tidy formatted data frame using expand.dft

lobster_abundance_tidy <- expand.dft(lobster_abundance_simp, var.names = NULL, freq = "COUNT")

# Use lobster_abundance_tidy for all calculations (except column graph)


# Filter lobster_traps to include only the 5 pertinent sites

lobster_traps_simp <- lobster_traps %>% 
  filter(SITE == "AQUE" | SITE == "CARP" | SITE == "IVEE" | SITE == "MOHK" | SITE == "NAPL")

```

```{r}

# C. Create column graphs of lobster abundance by year at each of the 5 sites

labels <- c(AQUE = "Arroyo Quemado", CARP = "Carpinteria", IVEE = "Isla Vista", MOHK = "Mohawk Reef", NAPL = "Naples Reef")

abundance_col <- ggplot(lobster_abundance_simp, aes(x = YEAR, y = COUNT))+
  geom_col(aes(fill = SITE)) +
  scale_y_continuous(expand = c(0,0)) +
  theme_classic() +
  xlab("\nYear") +
  ylab("Frequency\n") +
  facet_wrap(~SITE, scale = "free", labeller = labeller(SITE = labels)) +
  theme(legend.position = "none") +
  theme(panel.spacing = unit(1, "lines"))
  

abundance_col

# Note for Jess: Need to add space between facet_wrap labels and plots
# Note for Jess: Maybe create one line graph with all sites on it instead of column graph?
    
    
```

```{r}

# D. Create column graphs of fishing pressure (trap buoys) by year at each of the 5 sites

traps_col <- ggplot(lobster_traps_simp, aes(x = YEAR, y = TRAPS))+
  geom_col(aes(fill = SITE)) +
  scale_y_continuous(expand = c(0,0)) +
  theme_classic() +
  xlab("\nYear") +
  ylab("Frequency\n") +
  facet_wrap(~SITE, scale = "free", labeller = labeller(SITE = labels)) +
  theme(legend.position = "none") +
  theme(panel.spacing = unit(1, "lines"))
  

traps_col


# Note for Jess: Need to add space between facet_wrap labels and plots
# Note for Jess: Maybe create line plot for traps with all sites on one plot?

```






###2


```{r}
# 2

# Compare mean lobster sizes (carapace length (mm)) across the five sites for lobster observations collected in 2017.

# create a new df with mean lobster sizes at the 5 locations

mean_lobster_size <- lobster_abundance_tidy %>% 
  select(YEAR, SITE, SIZE) %>% 
  filter(YEAR == "2017") %>% 
  group_by(SITE) %>% 
  summarize(mean = mean(SIZE))

mean_lobster_size

# create a table comparing mean lobster sizes at the 5 locations

mean_lobster_tbl <- mean_lobster_size %>% 
  kable(col.names = c("Site", "Mean Lobster Carapace Length (mm)"),
        caption = "Mean Lobster Sizes at 5 Locations in 2017") %>% 
  kable_styling(bootstrap_options = c("striped", "hover", full_width = FALSE)) %>% 
  row_spec(row = 5, bold = TRUE, color = "green")

mean_lobster_tbl

# Note for Alex: Add a counts column for each location


# Run an ANOVA test

# Single factor: SITE (location)
# Number of levels: 5 (IVEE, AQUE, CARP, MOHK, NAPL)
# Random variable: SIZE (mm)

# Is there a significant difference in mean lobster size (mm) for sites IVEE, AQUE, CARP, MOHK, NAPL? 

# HO: mean lobster sizes across all sites are equal
# HA: At least two means differ significantly 

lobster_aov <- aov(SIZE ~ SITE, data = lobster_abundance_tidy)

summary(lobster_aov)

# post-hoc testing using Tukey's HSD

lobster_ph <- TukeyHSD(lobster_aov)

lobster_ph
```
Note: Put in-line referencing for F statistic and figure out how to interpret p-values for comparison of sites.

Mean lobster sizes (carapace length (mm)) at Arroyo Quemado, Naples Reef, Mohawk Reef, Isla Vista, and Carpinteria locations are significantly differerent in some instances from each other and not significantly different in others. (F(4) = 21.65, p, $\alpha$ = .05 with post-hoc Tukey's HSD, $\alpha = 0.05$.

Sig-diff: 

NAPL-AQUE
MOHK-CARP
NAPL-CARP
MOHK-IVEE
NAPL-IVEE
NAPL-MOHK

Not sig-diff:

CARP-AQUE
IVEE-AQUE
MOHK-AQUE
IVEE-CARP







```{r}

# Trying to make column graph with side-by-side columns by site


abundance_col_2 <- ggplot(lobster_abundance_simp, aes(x = YEAR, y = SIZE, group = SITE)) +
geom_col(aes(fill = SITE),
position = "dodge")

abundance_col_2

```

Note for Jess: For number 3, conduct 5 two sample t-tests for each location between 2012 and 2017 and see the significant changes at each MPA and non-MPA location and compare in discussion.

```{r}

# 3. At Isla Vista and Naples Reef, the two protected MPA sites (with zero fishing pressure), how do lobster sizes in 2012 and 2017 compare? At the non-MPA sites?
# Run 5 two-sample t-tests for each location, with samples being 2012 and 2017

# First, look at data and see if its normal

size_hist <- ggplot(lobster_abundance_tidy, aes(x = SIZE)) +
  geom_histogram() +
  facet_wrap(~ SITE)

size_hist

size_qq <- ggplot(lobster_abundance_tidy, aes(sample = SIZE)) +
  geom_qq() +
  facet_wrap(~ SITE)

size_qq

size_summary <- lobster_abundance_tidy %>% 
  group_by(SITE, YEAR) %>% 
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  summarize(
    sample_size = length(SIZE)
  )

size_summary

# Based on the histograms and qq-plots, the size data for the sites are approximately normal. However, certain sites have very small sample sizes, so is it correct to compare the samples using t-tests?


# Second, do F-tests for equal variance for each site to determine if we will use a Welch's t-test or Student's t-test 

# F-test for equal variances
# Null: The variances are equal (ratio of variances = 1)
# Alternative: The variances aren't equal (ratio of variances NOT = 1)

f_test_arroyo <- lobster_abundance_tidy %>% 
  filter(YEAR == "2012" | YEAR == "2017", SITE == "AQUE") %>% 
  var.test(SIZE ~ YEAR, data = .)

f_test_arroyo

# Based on the F-test, for Arroyo, we fail to reject the null that the variances for the 2012 and 2017 samples are equal (p = 0.069). Use a student's t-test.

f_test_arroyo <- lobster_abundance_tidy %>% 
  filter(YEAR == "2012" | YEAR == "2017", SITE == "AQUE") %>% 
  var.test(SIZE ~ YEAR, data = .)

f_test_arroyo
```

### 4

The legal minimum carapace size for lobster is 82.6 mm. What proportion of observed lobsters at each site are above the legal minimum? Does that proportion differ significantly across the 5 sites? (chi-sq)
```{r}
# 4

# create a df of lobster sizes above 83 mm at each site

lobster_counts <- lobster_abundance_tidy %>%
  filter(SITE != "NA", SIZE != "NA") %>% 
  count(SITE, SIZE) %>% 
  spread(SIZE, n) %>% 
  select(-SITE)
  
lobster_counts

# convert counts to proportions 
lobster_prop <- prop.table(as.matrix(lobster_counts), 1) # Proportions calculated by row (use 1)

lobster_prop

# run a chi-sq test 

lobster_x2 <- chisq.test(lobster_counts)

lobster_x2
```

